<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Website Maker</title>
<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    height: 100vh;
    font-family: system-ui, sans-serif;
    background: #f5f5f5;
    color: #111827;
    display: flex;
  }

  @font-face {
    font-family: "Pusab";
    src: local("Pusab"), local("Pusab Regular");
  }

  /* Slide list */
  #slideList {
    width: 160px;
    background: #f9fafb;
    border-right: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
  }

  #slidesContainer {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }

  .slide-item {
    padding: 8px;
    margin-bottom: 6px;
    border-radius: 8px;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    cursor: pointer;
    font-size: 13px;
  }

  .slide-item.active {
    border-color: #2563eb;
    background: #eff6ff;
  }

  #addSlideBtn {
    border-radius: 0;
    border-top: 1px solid #e5e7eb;
    background: #2563eb;
    color: white;
    padding: 10px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
  }

  /* Sidebar */
  #sidebar {
    width: 340px;
    background: #ffffff;
    padding: 20px;
    border-right: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    gap: 14px;
    overflow-y: auto;
  }

  h2 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
  }

  h3 {
    margin: 8px 0 4px;
    font-size: 15px;
    font-weight: 600;
  }

  label {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 4px;
    display: block;
    color: #4b5563;
  }

  input[type="text"] {
    width: 100%;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    font-size: 14px;
    outline: none;
  }

  button {
    padding: 9px 12px;
    background: #2563eb;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    color: white;
    font-size: 13px;
    font-weight: 600;
  }

  #deleteBtn { background: #dc2626; }
  #downloadBtn { background: #16a34a; }
  #addTextBtn { background: #0f766e; }
  #playtestBtn { background: #111827; }
  #uploadImageBtn { background: #6b21a8; }
  #exportLevelBtn { background: #0f766e; }
  #importLevelBtn { background: #6b7280; }

  .button-preview,
  .image-preview {
    width: 60px;
    height: 60px;
    background: #f3f4f6;
    border-radius: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: grab;
    margin: 0 8px 10px 0;
    border: 1px solid #e5e7eb;
  }

  .button-preview img,
  .image-preview img {
    width: 70%;
    height: 70%;
    object-fit: contain;
    pointer-events: none;
  }

  #uploadInput,
  #changeImageFile,
  #uploadImageInput,
  #importLevelInput {
    display: none;
  }

  #visibilityToggleContainer {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
  }

  #layerControls {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  #layerControls button {
    flex: 1 1 48%;
    font-size: 11px;
    padding: 6px 8px;
    background: #4b5563;
  }

  /* Canvas wrapper + panning */
  #canvasWrapper {
    flex: 1;
    overflow: hidden;
    position: relative;
    background: #f9fafb;
  }

  #canvas {
    position: absolute;
    top: 0;
    left: 0;
    transform-origin: 0 0;
  }

  .draggable {
    position: absolute;
    min-width: 60px;
    min-height: 40px;
    cursor: grab;
  }

  .draggable img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    pointer-events: none;
  }

  .text-element {
    padding: 6px 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  .text-content {
    width: 100%;
    height: 100%;
    outline: none;
    border: none;
    background: transparent;
    resize: none;
    overflow: hidden;
    font-size: 28px;
    color: white;
    font-family: "Pusab", system-ui;
    text-shadow:
      -2px -2px 0 black,
       2px -2px 0 black,
      -2px  2px 0 black,
       2px  2px 0 black;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  .selected {
    outline: 3px solid #2563eb;
    border-radius: 6px;
  }

  .resize-handle {
    position: absolute;
    width: 10px;
    height: 10px;
    background: #2563eb;
    border-radius: 50%;
    right: -5px;
    bottom: -5px;
    cursor: se-resize;
  }

  /* Action editor */
  #actionEditor {
    padding: 12px;
    background: #f3f4f6;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    display: none;
    flex-direction: column;
    gap: 10px;
  }

  .action-row {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-bottom: 8px;
    padding: 6px;
    border-radius: 8px;
    background: #e5e7eb;
  }

  .action-main {
    display: flex;
    gap: 6px;
  }

  .action-main select {
    flex: 0 0 140px;
    padding: 6px 8px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    font-size: 12px;
  }

  .action-main input {
    flex: 1;
    padding: 6px 8px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    font-size: 12px;
  }

  .action-main button {
    flex: 0 0 auto;
    padding: 6px 8px;
    background: #ef4444;
    font-size: 11px;
  }

  .action-targets {
    display: flex;
    gap: 6px;
  }

  .action-targets select {
    flex: 1;
    padding: 5px 8px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    font-size: 12px;
  }

  #addActionBtn {
    width: 100%;
    background: #4b5563;
  }

  /* Undo/Redo floating controls */
  #historyControls {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 20;
    display: flex;
    gap: 6px;
  }

  #historyControls button {
    padding: 6px 10px;
    font-size: 12px;
    border-radius: 6px;
    background: #111827;
  }

  #historyControls button:disabled {
    opacity: 0.4;
    cursor: default;
  }

  /* No-select while panning */
  body.noselect {
    user-select: none;
  }
</style>
</head>
<body>

<!-- SLIDE LIST -->
<div id="slideList">
  <div id="slidesContainer"></div>
  <button id="addSlideBtn">+ Add Slide</button>
</div>

<!-- SIDEBAR -->
<div id="sidebar">
  <h2>Website Maker</h2>

  <label>Site Title</label>
  <input id="siteTitle" type="text" placeholder="My Website">

  <label>Buttons</label>
  <div class="button-preview" draggable="true" data-src="https://via.placeholder.com/100?text=A">
    <img src="https://via.placeholder.com/100?text=A">
  </div>
  <div class="button-preview" draggable="true" data-src="https://via.placeholder.com/100?text=B">
    <img src="https://via.placeholder.com/100?text=B">
  </div>
  <div class="button-preview" draggable="true" data-src="https://via.placeholder.com/100?text=C">
    <img src="https://via.placeholder.com/100?text=C">
  </div>

  <button id="uploadBtn">Upload Custom Button</button>
  <input type="file" id="uploadInput" accept="image/*">

  <h3>Images</h3>
  <div id="imageLibrary"></div>
  <button id="uploadImageBtn">Upload Image</button>
  <input type="file" id="uploadImageInput" accept="image/*">

  <button id="addTextBtn">Add Text</button>

  <label style="margin-top:10px;">Element Visibility</label>
  <div id="visibilityToggleContainer">
    <input type="checkbox" id="visibilityToggle">
    <label for="visibilityToggle">Visible</label>
  </div>

  <h3>Layer</h3>
  <div id="layerControls">
    <button id="bringToFrontBtn">Bring to Front</button>
    <button id="sendToBackBtn">Send to Back</button>
    <button id="bringForwardBtn">Bring Forward</button>
    <button id="sendBackwardBtn">Send Backward</button>
  </div>

  <button id="deleteBtn">Delete Selected</button>
  <button id="downloadBtn">Download Website</button>
  <button id="playtestBtn">Playtest Website</button>

  <h3>Level Files</h3>
  <button id="exportLevelBtn">Export Level (.txt)</button>
  <button id="importLevelBtn">Import Level (.txt)</button>
  <input type="file" id="importLevelInput" accept=".txt">

  <h3>Actions (Buttons Only)</h3>
  <div id="actionEditor">
    <div id="actionsList"></div>
    <button id="addActionBtn">+ Add Action</button>

    <label>Keybind</label>
    <input id="keybindInput" type="text" placeholder="e.g. a, Enter, ArrowUp">

    <button id="changeImageUploadBtn">Upload image for Change Image</button>
    <input type="file" id="changeImageFile" accept="image/*">
  </div>
</div>

<!-- CANVAS WRAPPER + CANVAS -->
<div id="canvasWrapper">
  <div id="canvas">
    <div id="historyControls">
      <button id="undoBtn" disabled>‚ü≤ Undo</button>
      <button id="redoBtn" disabled>‚ü≥ Redo</button>
    </div>
  </div>
</div>

<script>
let slides = [];
let currentSlideId = null;
let selectedElement = null;
let idCounter = 1;
let currentImageActionInput = null;
let nextZIndex = 1;

/* Panning state */
let isPanning = false;
let panStartX = 0;
let panStartY = 0;
let canvasOffsetX = 0;
let canvasOffsetY = 0;

/* History (full-state snapshots) */
let history = [];
let historyIndex = -1;
let isRestoringHistory = false;

const slidesContainer = document.getElementById("slidesContainer");
const addSlideBtn = document.getElementById("addSlideBtn");
const canvasWrapper = document.getElementById("canvasWrapper");
const canvas = document.getElementById("canvas");

const uploadBtn = document.getElementById("uploadBtn");
const uploadInput = document.getElementById("uploadInput");
const uploadImageBtn = document.getElementById("uploadImageBtn");
const uploadImageInput = document.getElementById("uploadImageInput");
const imageLibrary = document.getElementById("imageLibrary");

const deleteBtn = document.getElementById("deleteBtn");
const downloadBtn = document.getElementById("downloadBtn");
const playtestBtn = document.getElementById("playtestBtn");
const siteTitleInput = document.getElementById("siteTitle");
const addTextBtn = document.getElementById("addTextBtn");

const visibilityToggle = document.getElementById("visibilityToggle");

const actionEditor = document.getElementById("actionEditor");
const actionsList = document.getElementById("actionsList");
const addActionBtn = document.getElementById("addActionBtn");
const keybindInput = document.getElementById("keybindInput");
const changeImageUploadBtn = document.getElementById("changeImageUploadBtn");
const changeImageFile = document.getElementById("changeImageFile");

const undoBtn = document.getElementById("undoBtn");
const redoBtn = document.getElementById("redoBtn");

const bringToFrontBtn = document.getElementById("bringToFrontBtn");
const sendToBackBtn = document.getElementById("sendToBackBtn");
const bringForwardBtn = document.getElementById("bringForwardBtn");
const sendBackwardBtn = document.getElementById("sendBackwardBtn");

const exportLevelBtn = document.getElementById("exportLevelBtn");
const importLevelBtn = document.getElementById("importLevelBtn");
const importLevelInput = document.getElementById("importLevelInput");

/* HISTORY HELPERS */
function getSnapshot() {
  return JSON.parse(JSON.stringify({
    slides,
    currentSlideId,
    idCounter,
    nextZIndex,
    canvasOffsetX,
    canvasOffsetY,
    siteTitle: siteTitleInput.value
  }));
}

function pushHistory() {
  if (isRestoringHistory) return;
  const snap = getSnapshot();
  history = history.slice(0, historyIndex + 1);
  history.push(snap);
  historyIndex = history.length - 1;
  updateHistoryButtons();
}

function restoreFromSnapshot(snap) {
  isRestoringHistory = true;
  slides = JSON.parse(JSON.stringify(snap.slides));
  currentSlideId = snap.currentSlideId;
  idCounter = snap.idCounter;
  nextZIndex = snap.nextZIndex || 1;
  canvasOffsetX = snap.canvasOffsetX || 0;
  canvasOffsetY = snap.canvasOffsetY || 0;
  siteTitleInput.value = snap.siteTitle || "";
  canvas.style.transform = `translate(${canvasOffsetX}px, ${canvasOffsetY}px)`;
  renderSlideList();
  renderCanvasForCurrentSlide();
  clearSelection();
  isRestoringHistory = false;
  updateHistoryButtons();
}

function updateHistoryButtons() {
  undoBtn.disabled = historyIndex <= 0;
  redoBtn.disabled = historyIndex >= history.length - 1 || history.length === 0;
}

undoBtn.addEventListener("click", () => {
  if (historyIndex <= 0) return;
  historyIndex--;
  restoreFromSnapshot(history[historyIndex]);
});

redoBtn.addEventListener("click", () => {
  if (historyIndex >= history.length - 1) return;
  historyIndex++;
  restoreFromSnapshot(history[historyIndex]);
});

/* SLIDES */
function createSlide(name) {
  const id = "slide-" + (slides.length + 1);
  const slide = {
    id,
    name: name || ("Slide " + (slides.length + 1)),
    elements: []
  };
  slides.push(slide);
  setCurrentSlide(id);
  pushHistory();
}

function renderSlideList() {
  slidesContainer.innerHTML = "";
  slides.forEach(slide => {
    const div = document.createElement("div");
    div.className = "slide-item" + (slide.id === currentSlideId ? " active" : "");
    div.textContent = slide.name;
    div.dataset.slideId = slide.id;
    div.addEventListener("click", () => {
      if (selectedElement) saveActionsToSelected();
      currentSlideId = slide.id;
      renderSlideList();
      renderCanvasForCurrentSlide();
      clearSelection();
      pushHistory();
    });
    slidesContainer.appendChild(div);
  });
}

function getCurrentSlide() {
  return slides.find(s => s.id === currentSlideId) || null;
}

function setCurrentSlide(id) {
  currentSlideId = id;
  renderSlideList();
  renderCanvasForCurrentSlide();
  clearSelection();
}

/* CANVAS RENDERING */
function renderCanvasForCurrentSlide() {
  canvas.querySelectorAll(".draggable").forEach(el => el.remove());
  const slide = getCurrentSlide();
  if (!slide) return;

  slide.elements.forEach(e => {
    if (typeof e.zIndex !== "number") {
      e.zIndex = nextZIndex++;
    }
  });

  slide.elements
    .slice()
    .sort((a, b) => (a.zIndex || 0) - (b.zIndex || 0))
    .forEach(elData => {
      const el = createDOMElementFromData(elData);
      canvas.appendChild(el);
    });
}

/* ELEMENT CREATION */
function createDOMElementFromData(data) {
  const div = document.createElement("div");
  div.className = "draggable";
  div.dataset.id = data.id;
  div.dataset.kind = data.kind;
  div.dataset.slideId = data.slideId;
  div.style.left = data.x;
  div.style.top = data.y;
  div.style.width = data.width;
  div.style.height = data.height;
  div.style.display = data.visible ? (data.kind === "text" ? "flex" : "block") : "none";
  div.style.zIndex = data.zIndex || 1;

  if (data.kind === "button") {
    const img = document.createElement("img");
    img.src = data.src;
    div.appendChild(img);
  } else if (data.kind === "image") {
    const img = document.createElement("img");
    img.src = data.src;
    img.style.width = "100%";
    img.style.height = "100%";
    img.style.objectFit = "contain";
    div.appendChild(img);
  } else if (data.kind === "text") {
    div.classList.add("text-element");
    const textarea = document.createElement("textarea");
    textarea.className = "text-content";
    textarea.value = data.text || "New Text";
    div.appendChild(textarea);
    textarea.addEventListener("input", () => {
      data.text = textarea.value;
      pushHistory();
    });
  }

  const handle = document.createElement("div");
  handle.className = "resize-handle";
  div.appendChild(handle);

  makeDraggable(div);
  makeResizable(div, handle);
  div.addEventListener("mousedown", () => selectElement(div));

  return div;
}

/* BUTTONS FROM SIDEBAR */
document.querySelectorAll(".button-preview").forEach(btn => {
  btn.addEventListener("dragstart", e => {
    e.dataTransfer.setData("image-src", btn.dataset.src);
    e.dataTransfer.setData("type", "button");
  });
});

/* IMAGES FROM LIBRARY */
function addImagePreviewToLibrary(src) {
  const preview = document.createElement("div");
  preview.className = "image-preview";
  preview.draggable = true;
  preview.dataset.src = src;

  const img = document.createElement("img");
  img.src = src;
  preview.appendChild(img);

  preview.addEventListener("dragstart", e => {
    e.dataTransfer.setData("image-src", src);
    e.dataTransfer.setData("type", "image");
  });

  imageLibrary.appendChild(preview);
}

/* CANVAS DROP */
canvasWrapper.addEventListener("dragover", e => e.preventDefault());
canvasWrapper.addEventListener("drop", e => {
  e.preventDefault();
  const type = e.dataTransfer.getData("type");
  const src = e.dataTransfer.getData("image-src");
  if (!src) return;

  const rect = canvasWrapper.getBoundingClientRect();
  const x = e.clientX - rect.left - canvasOffsetX;
  const y = e.clientY - rect.top - canvasOffsetY;

  if (type === "button") {
    createButton(src, x, y);
  } else if (type === "image") {
    createImageElement(src, x, y);
  }
});

function createButton(src, x, y) {
  const slide = getCurrentSlide();
  if (!slide) return;

  const id = "el-" + (idCounter++);
  const data = {
    id,
    slideId: slide.id,
    kind: "button",
    src,
    x: x + "px",
    y: y + "px",
    width: "80px",
    height: "80px",
    visible: true,
    actions: [],
    keybind: "",
    zIndex: nextZIndex++
  };
  slide.elements.push(data);

  const el = createDOMElementFromData(data);
  canvas.appendChild(el);
  pushHistory();
}

/* TEXT */
addTextBtn.addEventListener("click", () => {
  const slide = getCurrentSlide();
  if (!slide) return;

  const id = "el-" + (idCounter++);
  const data = {
    id,
    slideId: slide.id,
    kind: "text",
    text: "New Text",
    x: "100px",
    y: "100px",
    width: "200px",
    height: "80px",
    visible: true,
    zIndex: nextZIndex++
  };
  slide.elements.push(data);

  const el = createDOMElementFromData(data);
  canvas.appendChild(el);
  pushHistory();
});

/* UPLOAD NORMAL IMAGE (non-button, also saved to library) */
uploadImageBtn.addEventListener("click", () => uploadImageInput.click());

uploadImageInput.addEventListener("change", () => {
  const file = uploadImageInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    const src = e.target.result;
    addImagePreviewToLibrary(src);
    createImageElement(src);
  };

  reader.readAsDataURL(file);
});

function createImageElement(src, x = 120, y = 120) {
  const slide = getCurrentSlide();
  if (!slide) return;

  const id = "el-" + (idCounter++);
  const data = {
    id,
    slideId: slide.id,
    kind: "image",
    src,
    x: x + "px",
    y: y + "px",
    width: "200px",
    height: "200px",
    visible: true,
    zIndex: nextZIndex++
  };

  slide.elements.push(data);

  const el = createDOMElementFromData(data);
  canvas.appendChild(el);

  pushHistory();
}

/* DRAGGING */
function makeDraggable(el) {
  let offsetX, offsetY;

  el.addEventListener("mousedown", e => {
    if (isPanning) return;
    if (e.target.classList.contains("resize-handle")) return;

    selectElement(el);

    const wrapperRect = canvasWrapper.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    offsetX = e.clientX - elRect.left;
    offsetY = e.clientY - elRect.top;

    function move(e2) {
      const x = e2.clientX - wrapperRect.left - canvasOffsetX - offsetX;
      const y = e2.clientY - wrapperRect.top - canvasOffsetY - offsetY;

      el.style.left = x + "px";
      el.style.top = y + "px";

      const data = getElementData(el);
      if (data) {
        data.x = el.style.left;
        data.y = el.style.top;
      }
    }

    function stop() {
      window.removeEventListener("mousemove", move);
      window.removeEventListener("mouseup", stop);
      pushHistory();
    }

    window.addEventListener("mousemove", move);
    window.addEventListener("mouseup", stop);
  });
}

/* RESIZING */
function makeResizable(el, handle) {
  let startX, startY, startW, startH;

  handle.addEventListener("mousedown", e => {
    e.stopPropagation();
    if (isPanning) return;
    selectElement(el);

    startX = e.clientX;
    startY = e.clientY;
    startW = parseInt(el.style.width, 10);
    startH = parseInt(el.style.height, 10);

    function resize(e2) {
      el.style.width = Math.max(40, startW + (e2.clientX - startX)) + "px";
      el.style.height = Math.max(30, startH + (e2.clientY - startY)) + "px";

      const data = getElementData(el);
      if (data) {
        data.width = el.style.width;
        data.height = el.style.height;
      }
    }

    function stopResize() {
      window.removeEventListener("mousemove", resize);
      window.removeEventListener("mouseup", stopResize);
      pushHistory();
    }

    window.addEventListener("mousemove", resize);
    window.addEventListener("mouseup", stopResize);
  });
}

/* ELEMENT DATA */
function getElementData(el) {
  const id = el.dataset.id;
  const slide = getCurrentSlide();
  if (!slide) return null;
  return slide.elements.find(e => e.id === id) || null;
}

/* SELECTION */
function clearSelection() {
  if (selectedElement) selectedElement.classList.remove("selected");
  selectedElement = null;
  actionEditor.style.display = "none";
  visibilityToggle.checked = false;
}

function selectElement(el) {
  if (selectedElement) {
    saveActionsToSelected();
    selectedElement.classList.remove("selected");
  }

  selectedElement = el;
  el.classList.add("selected");

  const data = getElementData(el);
  if (!data) return;

  visibilityToggle.checked = !!data.visible;

  if (data.kind === "button") {
    actionEditor.style.display = "flex";
    loadActions(data);
  } else {
    actionEditor.style.display = "none";
  }
}

/* VISIBILITY */
visibilityToggle.addEventListener("change", () => {
  if (!selectedElement) return;
  const data = getElementData(selectedElement);
  if (!data) return;
  data.visible = visibilityToggle.checked;
  selectedElement.style.display = data.visible
    ? (data.kind === "text" ? "flex" : "block")
    : "none";
  pushHistory();
});

/* LAYER CONTROLS */
function getSlideAndElementForSelected() {
  if (!selectedElement) return { slide: null, data: null };
  const slide = getCurrentSlide();
  if (!slide) return { slide: null, data: null };
  const data = slide.elements.find(e => e.id === selectedElement.dataset.id) || null;
  return { slide, data };
}

function normalizeZIndices(slide) {
  slide.elements
    .sort((a, b) => (a.zIndex || 0) - (b.zIndex || 0))
    .forEach((e, i) => {
      e.zIndex = i + 1;
    });
  nextZIndex = slide.elements.length + 1;
}

bringToFrontBtn.addEventListener("click", () => {
  const { slide, data } = getSlideAndElementForSelected();
  if (!slide || !data) return;
  normalizeZIndices(slide);
  data.zIndex = nextZIndex++;
  renderCanvasForCurrentSlide();
  pushHistory();
});

sendToBackBtn.addEventListener("click", () => {
  const { slide, data } = getSlideAndElementForSelected();
  if (!slide || !data) return;
  normalizeZIndices(slide);
  data.zIndex = 1;
  slide.elements.forEach(e => {
    if (e !== data) e.zIndex++;
  });
  nextZIndex = slide.elements.length + 1;
  renderCanvasForCurrentSlide();
  pushHistory();
});

bringForwardBtn.addEventListener("click", () => {
  const { slide, data } = getSlideAndElementForSelected();
  if (!slide || !data) return;
  normalizeZIndices(slide);
  const current = data.zIndex || 1;
  const maxZ = slide.elements.length;
  if (current >= maxZ) return;
  const targetZ = current + 1;
  slide.elements.forEach(e => {
    if (e !== data && e.zIndex === targetZ) e.zIndex = current;
  });
  data.zIndex = targetZ;
  renderCanvasForCurrentSlide();
  pushHistory();
});

sendBackwardBtn.addEventListener("click", () => {
  const { slide, data } = getSlideAndElementForSelected();
  if (!slide || !data) return;
  normalizeZIndices(slide);
  const current = data.zIndex || 1;
  if (current <= 1) return;
  const targetZ = current - 1;
  slide.elements.forEach(e => {
    if (e !== data && e.zIndex === targetZ) e.zIndex = current;
  });
  data.zIndex = targetZ;
  renderCanvasForCurrentSlide();
  pushHistory();
});

/* ACTIONS UI */
function loadActions(data) {
  actionsList.innerHTML = "";
  keybindInput.value = data.keybind || "";

  const list = data.actions && data.actions.length ? data.actions : [];
  if (!list.length) {
    createActionRow("none", "");
  } else {
    list.forEach(a => createActionRow(a.type, a.value));
  }
}

function createActionRow(type = "none", value = "") {
  const row = document.createElement("div");
  row.className = "action-row";

  const main = document.createElement("div");
  main.className = "action-main";

  const select = document.createElement("select");
  select.innerHTML = `
    <option value="none">üö´ None</option>
    <option value="url">üîó Go to URL</option>
    <option value="alert">üí¨ Show alert</option>
    <option value="sound">üîä Play sound</option>
    <option value="js">‚öôÔ∏è Run JavaScript</option>
    <option value="changeImage">üñºÔ∏è Change image</option>
    <option value="bounce">üü¶ Bounce on hold</option>
    <option value="toggleVisibility">üëÅÔ∏è Toggle element visibility</option>
    <option value="switchSlide">üìÑ Switch to slide</option>
  `;
  select.value = type;

  const input = document.createElement("input");
  input.value = value || "";
  input.placeholder = "Value (URL, JS, sound, etc.)";

  const del = document.createElement("button");
  del.textContent = "X";
  del.addEventListener("click", () => {
    row.remove();
    pushHistory();
  });

  main.appendChild(select);
  main.appendChild(input);
  main.appendChild(del);

  const targets = document.createElement("div");
  targets.className = "action-targets";

  const elementSelect = document.createElement("select");
  const slideSelect = document.createElement("select");

  elementSelect.style.display = "none";
  slideSelect.style.display = "none";

  targets.appendChild(elementSelect);
  targets.appendChild(slideSelect);

  row.appendChild(main);
  row.appendChild(targets);
  actionsList.appendChild(row);

  function refreshTargets() {
    const t = select.value;
    const slide = getCurrentSlide();
    elementSelect.innerHTML = "";
    slideSelect.innerHTML = "";

    if (t === "toggleVisibility") {
      elementSelect.style.display = "block";
      slideSelect.style.display = "none";

      if (slide) {
        slide.elements.forEach(e => {
          const opt = document.createElement("option");
          opt.value = e.id;
          opt.textContent = e.id + " (" + e.kind + ")";
          elementSelect.appendChild(opt);
        });
      }
      if (value) elementSelect.value = value;
      elementSelect.addEventListener("change", () => {
        input.value = elementSelect.value;
        pushHistory();
      });
      if (!input.value && elementSelect.value) input.value = elementSelect.value;
    } else if (t === "switchSlide") {
      elementSelect.style.display = "none";
      slideSelect.style.display = "block";

      slides.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = s.name;
        slideSelect.appendChild(opt);
      });
      if (value) slideSelect.value = value;
      slideSelect.addEventListener("change", () => {
        input.value = slideSelect.value;
        pushHistory();
      });
      if (!input.value && slideSelect.value) input.value = slideSelect.value;
    } else {
      elementSelect.style.display = "none";
      slideSelect.style.display = "none";
    }
  }

  select.addEventListener("change", () => {
    refreshTargets();
    pushHistory();
  });
  input.addEventListener("input", () => {
    pushHistory();
  });

  refreshTargets();

  return { select, input, row };
}

addActionBtn.addEventListener("click", () => {
  createActionRow();
  pushHistory();
});

keybindInput.addEventListener("input", () => {
  pushHistory();
});

function saveActionsToSelected() {
  if (!selectedElement) return;
  const data = getElementData(selectedElement);
  if (!data || data.kind !== "button") return;

  const rows = actionsList.querySelectorAll(".action-row");
  const actions = [];

  rows.forEach(r => {
    const type = r.querySelector("select").value;
    const input = r.querySelector("input");
    const value = (input.value || "").trim();
    if (type && type !== "none") {
      actions.push({ type, value });
    }
  });

  data.actions = actions;
  data.keybind = keybindInput.value.trim();
}

/* CHANGE IMAGE UPLOAD */
changeImageUploadBtn.addEventListener("click", () => {
  const rows = actionsList.querySelectorAll(".action-row");
  let targetRow = null;

  for (let i = rows.length - 1; i >= 0; i--) {
    const select = rows[i].querySelector("select");
    if (select.value === "changeImage") {
      targetRow = rows[i];
      break;
    }
  }

  if (!targetRow) {
    const created = createActionRow("changeImage", "");
    targetRow = created.row;
  }

  currentImageActionInput = targetRow.querySelector("input");
  changeImageFile.click();
});

changeImageFile.addEventListener("change", () => {
  const file = changeImageFile.files[0];
  if (!file || !currentImageActionInput) return;

  const reader = new FileReader();
  reader.onload = e => {
    currentImageActionInput.value = e.target.result;
    pushHistory();
  };
  reader.readAsDataURL(file);
});

/* UPLOAD CUSTOM BUTTON */
uploadBtn.addEventListener("click", () => uploadInput.click());

uploadInput.addEventListener("change", () => {
  const file = uploadInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    const src = e.target.result;

    const preview = document.createElement("div");
    preview.className = "button-preview";
    preview.draggable = true;
    preview.dataset.src = src;

    const img = document.createElement("img");
    img.src = src;
    preview.appendChild(img);

    preview.addEventListener("dragstart", ev => {
      ev.dataTransfer.setData("image-src", src);
      ev.dataTransfer.setData("type", "button");
    });

    document.getElementById("sidebar").insertBefore(preview, uploadBtn.nextSibling);
  };

  reader.readAsDataURL(file);
});

/* DELETE */
deleteBtn.addEventListener("click", () => {
  if (!selectedElement) return;
  const slide = getCurrentSlide();
  if (!slide) return;
  const id = selectedElement.dataset.id;
  slide.elements = slide.elements.filter(e => e.id !== id);
  selectedElement.remove();
  clearSelection();
  pushHistory();
});

/* ADD SLIDE */
addSlideBtn.addEventListener("click", () => {
  createSlide();
});

/* DOWNLOAD / EXPORT WEBSITE */
downloadBtn.addEventListener("click", () => {
  saveActionsToSelected();

  const title = siteTitleInput.value.trim() || "My Website";
  const html = exportHTML(title);

  const blob = new Blob([html], { type: "text/html" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = title.replace(/\s+/g, "-").toLowerCase() + ".html";
  a.click();
  URL.revokeObjectURL(url);
});

/* PLAYTEST (opens exported site in new tab) */
playtestBtn.addEventListener("click", () => {
  saveActionsToSelected();
  const title = siteTitleInput.value.trim() || "My Website";
  const html = exportHTML(title);
  const blob = new Blob([html], { type: "text/html" });
  const url = URL.createObjectURL(blob);
  window.open(url, "_blank");
});

/* EXPORT LEVEL (.txt) */
exportLevelBtn.addEventListener("click", () => {
  saveActionsToSelected();
  const data = getSnapshot(); // full state snapshot
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: "text/plain" });
  const a = document.createElement("a");
  const title = siteTitleInput.value.trim() || "level";
  a.href = URL.createObjectURL(blob);
  a.download = title.replace(/\s+/g, "_").toLowerCase() + "_level.txt";
  a.click();
});

/* IMPORT LEVEL (.txt) */
importLevelBtn.addEventListener("click", () => {
  importLevelInput.value = "";
  importLevelInput.click();
});

importLevelInput.addEventListener("change", () => {
  const file = importLevelInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);

      isRestoringHistory = true;

      slides = data.slides || [];
      currentSlideId = data.currentSlideId || (slides[0] && slides[0].id) || null;
      idCounter = data.idCounter || 1;
      nextZIndex = data.nextZIndex || 1;
      canvasOffsetX = data.canvasOffsetX || 0;
      canvasOffsetY = data.canvasOffsetY || 0;
      siteTitleInput.value = data.siteTitle || "";

      canvas.style.transform = `translate(${canvasOffsetX}px, ${canvasOffsetY}px)`;

      renderSlideList();
      renderCanvasForCurrentSlide();
      clearSelection();

      history = [];
      historyIndex = -1;
      isRestoringHistory = false;
      pushHistory();
    } catch (err) {
      alert("Failed to import level: invalid file.");
      console.error(err);
    }
  };
  reader.readAsText(file);
});

/* EXPORT HTML (runtime) */
function exportHTML(title) {
  const slidesHTML = slides.map((slide, index) => {
    const itemsHTML = slide.elements.map(el => {
      if (el.kind === "button") {
        const actions = encodeURIComponent(JSON.stringify(el.actions || []));
        const keybind = encodeURIComponent(el.keybind || "");
        const display = el.visible ? "block" : "none";
        return `
<div class="item button-item"
     data-kind="button"
     data-id="${el.id}"
     data-slide-id="${slide.id}"
     data-actions="${actions}"
     data-keybind="${keybind}"
     style="left:${el.x}; top:${el.y}; width:${el.width}; height:${el.height}; display:${display}; z-index:${el.zIndex || 1};">
  <img src="${el.src}">
</div>`;
      } else if (el.kind === "image") {
        const display = el.visible ? "block" : "none";
        return `
<div class="item image-item"
     data-kind="image"
     data-id="${el.id}"
     data-slide-id="${slide.id}"
     style="left:${el.x}; top:${el.y}; width:${el.width}; height:${el.height}; display:${display}; z-index:${el.zIndex || 1};">
  <img src="${el.src}" style="width:100%; height:100%; object-fit:contain;">
</div>`;
      } else if (el.kind === "text") {
        const safeText = (el.text || "New Text")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
        const display = el.visible ? "flex" : "none";
        return `
<div class="item text-item"
     data-kind="text"
     data-id="${el.id}"
     data-slide-id="${slide.id}"
     style="left:${el.x}; top:${el.y}; width:${el.width}; height:${el.height}; display:${display}; z-index:${el.zIndex || 1};">
  <div class="text-content">
    ${safeText}
  </div>
</div>`;
      }
      return "";
    }).join("\n");

    return `
<div class="slide" data-slide-id="${slide.id}" style="display:${index === 0 ? "block" : "none"};">
${itemsHTML}
</div>`;
  }).join("\n");

  const slidesData = encodeURIComponent(JSON.stringify(slides.map(s => ({ id: s.id, name: s.name }))));

  return `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>${title}</title>
<style>
  * { box-sizing:border-box; }
  body { margin:0; background:#fafafa; overflow:hidden; }

  @font-face {
    font-family:"Pusab";
    src: local("Pusab"), local("Pusab Regular");
  }

  .slide {
    position:relative;
    width:100vw;
    height:100vh;
    overflow:hidden;
  }

  .item { position:absolute; }

  .button-item img,
  .image-item img {
    width:100%;
    height:100%;
    object-fit:contain;
  }

  .text-item .text-content {
    width:100%;
    height:100%;
    font-size:28px;
    font-family:"Pusab", system-ui;
    color:white;
    text-shadow:
      -2px -2px 0 black,
       2px -2px 0 black,
      -2px  2px 0 black,
       2px  2px 0 black;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
  }
</style>
</head>
<body>
${slidesHTML}
<script>
(function() {
  const slidesMeta = JSON.parse(decodeURIComponent("${slidesData}"));
  let currentSlideId = slidesMeta.length ? slidesMeta[0].id : null;

  function showSlide(id) {
    currentSlideId = id;
    document.querySelectorAll(".slide").forEach(s => {
      s.style.display = s.dataset.slideId === id ? "block" : "none";
    });
  }

  function runAction(type, value, contextEl) {
    value = decodeURIComponent(value || "");

    if (type === "url") {
      if (value) window.location.href = value;
    } else if (type === "alert") {
      alert(value || "");
    } else if (type === "sound") {
      if (value) {
        try { new Audio(value).play(); } catch (e) { console.error(e); }
      }
    } else if (type === "js") {
      if (value) {
        try { new Function(value)(); } catch (e) { console.error(e); }
      }
    } else if (type === "changeImage") {
      const img = contextEl.querySelector("img");
      if (img && value) img.src = value;
    } else if (type === "bounce") {
      const el = contextEl;
      el.style.transition = "transform 0.12s cubic-bezier(.2,.6,.4,1)";
      el.style.transform = "scale(0.82)";
      function reset() {
        el.style.transition = "transform 0.18s cubic-bezier(.2,.6,.4,1.4)";
        el.style.transform = "scale(1)";
        window.removeEventListener("pointerup", reset);
        window.removeEventListener("pointerleave", reset);
      }
      window.addEventListener("pointerup", reset);
      window.addEventListener("pointerleave", reset);
    } else if (type === "toggleVisibility") {
      const targetId = value;
      const target = document.querySelector('.item[data-id="' + targetId + '"]');
      if (target) {
        const isHidden = (target.style.display === "none" || getComputedStyle(target).display === "none");
        if (target.classList.contains("text-item")) {
          target.style.display = isHidden ? "flex" : "none";
        } else {
          target.style.display = isHidden ? "block" : "none";
        }
      }
    } else if (type === "switchSlide") {
      const slideId = value;
      if (slideId) showSlide(slideId);
    }
  }

  const items = document.querySelectorAll(".item");
  const keyMap = {};

  items.forEach(el => {
    const kind = el.dataset.kind;
    const actionsRaw = el.dataset.actions || "%5B%5D";
    let actions = [];
    try {
      actions = JSON.parse(decodeURIComponent(actionsRaw));
    } catch (e) {
      actions = [];
    }
    const keybind = decodeURIComponent(el.dataset.keybind || "").trim();

    const bounceActions = actions.filter(a => a.type === "bounce");
    const clickActions = actions.filter(a => a.type !== "bounce");

    if (kind === "button") {
      if (bounceActions.length) {
        el.addEventListener("pointerdown", function() {
          bounceActions.forEach(a => runAction(a.type, a.value, el));
        });
      }
      el.addEventListener("click", function() {
        clickActions.forEach(a => runAction(a.type, a.value, el));
      });
    }

    if (keybind) {
      keyMap[keybind.toLowerCase()] = actions;
    }
  });

  window.addEventListener("keydown", e => {
    const key = e.key.toLowerCase();
    if (keyMap[key]) {
      keyMap[key].forEach(a => {
        if (a.type !== "bounce") {
          runAction(a.type, a.value, document.body);
        }
      });
    }
  });

  if (currentSlideId) showSlide(currentSlideId);
})();
<\/script>
</body>
</html>`;
}

/* PANNING LOGIC */
canvasWrapper.addEventListener("mousedown", e => {
  if (e.target === canvasWrapper || e.target === canvas) {
    isPanning = true;
    document.body.classList.add("noselect");
    panStartX = e.clientX - canvasOffsetX;
    panStartY = e.clientY - canvasOffsetY;
  }
});

window.addEventListener("mousemove", e => {
  if (!isPanning) return;
  canvasOffsetX = e.clientX - panStartX;
  canvasOffsetY = e.clientY - panStartY;
  canvas.style.transform = `translate(${canvasOffsetX}px, ${canvasOffsetY}px)`;
});

window.addEventListener("mouseup", () => {
  if (!isPanning) return;
  isPanning = false;
  document.body.classList.remove("noselect");
  pushHistory();
});

/* INIT */
createSlide("Slide 1");
pushHistory();
</script>

</body>
</html>
